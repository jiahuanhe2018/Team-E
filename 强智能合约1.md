# 强智能合约

以太坊智能合约的出现，是区块链的革命性进步，但是在合约的互相调用协作、手续费和升级性上还有很多限制，本文探讨一种放开这些限制的智能合约，暂称之为强智能合约

### 底层公链
首先说下底层公链，用什么共识不是重点，共识是可以不断改进的，但是合约不能改，今天用基于pow的以太坊发的合约，未来在基于pos的以太坊依然有效。为便于开发，我们将使用tendermint作为底层公链

底层公链是无币公链，激励层与公链完全隔离，但是支持使用合约发币，我们也会基于强智能合约发行官方token，因为节点没有激励，所以主要是官方的节点，谁要是不信任官方节点，也可以搭自己的节点接进来

为保证通信质量和随机数生成，所有出块节点都是官方节点，用户自己接进来的节点只能做见证节点

### 合约互相协作
谁都可以发token给其他合约调用，可以合约A调用合约B，合约B再调合约C，所有调用过程全部单线程异步，采用事件模型，比如甲用1个ACoin换乙的100个BCoin：

>     甲用http调用A合约的换币方法，并提供甲的签名、乙的签名和授权（授权本次A调用B的转账方法）
>         节点打包区块，将http请求挂起
>             A检查并锁定甲的账户，准备把甲的1个ACoin转给乙，监听B的事件
>             A调用B的转账方法，提供了乙的签名和授权
>                 B检查了乙的签名和授权，锁定乙的账户，准备把乙的100个BCoin转给甲，监听A的事件
>                 B发起一个准备事件
>             A收到B的事件，把甲的1个ACoin转给乙
>             A解锁甲的账户，发起一个换币成功事件
>                 B收到A的事件，把乙的100个BCoin转给甲
>         节点收到A的事件，写入日志，把http请求返回
>     甲收到http返回结果，确定换币成功
    
原子性操作，所有调用在写入数据前先挂起，等待源头A合约的通知，一旦A发起成功事件，一波把数据全写完。如果出现这样的情况，A->B->C->D->E，在多级的调用过程中，ABC挂起写数据操作，D检查签名的时候超gas了，发出失败事件，ABCD放弃写操作，E没有被调用，ABCDE都没有写入数据，保证了原子性

合约有gas和内存的限制，但是没有手续费，这个上限通常比较高，可以保证正常应用不超出，可以免费使用，一旦超出，就会失败。频繁失败的合约会被节点冻结一段时间，用于保护节点的资源不被恶意合约占用

### 合约升级
我们为合约提供了可升级性，合约有版本号，合约修改后版本号自增，合约地址不变。是否信任新版本合约，由开发者自行决定，类似包管理器。比如A合约版本1升级为版本2，合约B的开发者可以设置是否只信任版本1，或者任意版本都信任；如果只信任版本1，那么调用A合约就会出错，这时候需要开发者去设置信任版本2，才能走通；如果任意版本都信任，则不需要设置就能走通

### 合约使用随机数
每次出块，出块节点生成N个随机数，N等于块内Tx数量，即每个Tx都有一个确定的随机数，这个数值随Tx一起写入区块链，在这个Tx内的合约调用随机数都是这个值，由于出块的都是官方节点，所以随机数的信任由官方保证

### 个人见解
方案比较中心化，这个就像迅雷和BT，迅雷搭建了自己的加速服务器，用中心化的方式加速了BT的下载，对普通用户来说对是否中心化是无感知的，只要下载速度快就行。对我们来说，由于主要节点都是官方自有节点，所以不担心性能问题，我们主要是在扩展性上做了探索，我们不排斥去中心化，任何人都可以搭节点接入进来，跟官方节点是平级的，也支持大家发币，跟官方币也是平级的，从利益角度来讲，我们才是真去中心化的，我们在链上挣钱的优势和大家是一样的，这点跟BTC、ETH、EOS比较：
- BTC：矿霸和早期进入者占据绝大多数红利
- ETH：官方和早期进入者占据绝大多数红利
- EOS：官方联合21个矿工占据绝大多数红利

我们经常诟病的中心化和安全性，那是因为大多数红利都被少数人占去了，所以怪罪于中心化，那些获利的矿霸、官方和21个矿工们，从来没半点微言。我们经常诟病BAT是中心化，facebook是中心化，也是同理，问题在于他们拿到了绝大部分红利，我们付出了隐私数据，提供了口碑，甚至接盘做了韭菜，却什么红利都没得到，我们怪罪于中心化的时候，其实恨不得自己就是那中心的少数人。所以我们从利益上去中心化，才是真去中心化